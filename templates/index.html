<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S - T'on nom</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        /* CSS SOMBRE & MODERNE */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; }
        
        /* SIDEBAR (GAUCHE) */
        #sidebar { width: 260px; background: #000; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 15px; }
        .app-title { font-size: 1.2rem; font-weight: bold; color: #4ec9b0; margin-bottom: 20px; text-align: center; letter-spacing: 2px; }
        #new-chat-btn { background: #007acc; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; transition: 0.3s; }
        #new-chat-btn:hover { background: #005a9e; }
        
        #history-list { flex-grow: 1; overflow-y: auto; }
        .history-item { padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; font-size: 0.9rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item:hover { background: #222; color: white; }
        .history-item.active { background: #1e1e1e; color: #fff; border-left: 3px solid #4ec9b0; }

        /* MAIN (DROITE) */
        #main-area { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        
        /* HEADER */
        header { padding: 15px 20px; background: #181818; border-bottom: 1px solid #333; display: flex; gap: 20px; align-items: center; }
        select { background: #2d2d2d; color: white; border: 1px solid #444; padding: 8px; border-radius: 5px; cursor: pointer; }
        .toggle-group { display: flex; gap: 15px; margin-left: auto; }
        label { cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; user-select: none; }
        input[type="checkbox"] { accent-color: #4ec9b0; transform: scale(1.1); }

        /* CHAT */
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        .message { padding: 15px 20px; border-radius: 12px; line-height: 1.6; max-width: 80%; }
        .user { background-color: #2b313b; align-self: flex-end; }
        .ai { background-color: #222; align-self: flex-start; }
        pre { background: #0d0d0d; padding: 15px; border-radius: 8px; overflow-x: auto; }

        /* FOOTER (INPUT) */
        #input-area { padding: 20px; background: #181818; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex-grow: 1; padding: 15px; border-radius: 10px; border: 1px solid #444; background: #252526; color: white; outline: none; }
        button#send-btn { background: #4ec9b0; color: #000; border: none; padding: 0 25px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.2rem; }
        button#send-btn:hover { background: #3db89f; }
        
        /* Indicateur Flash √âcran */
        .flash { animation: flash-animation 1s; }
        @keyframes flash-animation { 0% { background-color: #fff; } 100% { background-color: #121212; } }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="app-title">J.A.R.V.I.S</div>
        <button id="new-chat-btn" onclick="startNewChat()">+ Nouvelle Chat</button>
        <div id="history-list"></div>
    </div>

    <div id="main-area">
        <header>
            <select id="model-select">
                <option value="llama3.1" selected>üöÄ Llama 3.1 (Rapide)</option>
                <option value="mixtral">‚ö° Mixtral (√âquilibr√©)</option>
                <option value="llama3.1:70b">üß† Llama 70B (G√©nie)</option>
                <option value="llava">üëÅÔ∏è Vision (Auto)</option>
            </select>

            <div class="toggle-group">
                <label><input type="checkbox" id="web-toggle"> üåç Web</label>
                <label><input type="checkbox" id="screen-toggle"> üëÅÔ∏è √âcran</label>
            </div>
        </header>

        <div id="chat-box"></div>

        <form id="input-area">
            <input type="file" id="file-input" style="display:none">
            <button type="button" onclick="document.getElementById('file-input').click()" style="background:none;border:none;font-size:1.5rem;cursor:pointer">üìé</button>
            <input type="text" id="user-input" placeholder="Message √† J.A.R.V.I.S..." required autocomplete="off">
            <button type="submit" id="send-btn">‚û§</button>
        </form>
    </div>

    <script>
        let currentChatId = null;
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const historyList = document.getElementById('history-list');

        window.onload = async () => {
            await loadConversations();
            await startNewChat();
        };

        async function loadConversations() {
            const res = await fetch('/get_conversations');
            const chats = await res.json();
            historyList.innerHTML = '';
            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerText = chat[1];
                if (chat[0] === currentChatId) div.classList.add('active');
                div.onclick = () => loadChat(chat[0]);
                historyList.appendChild(div);
            });
        }

        async function startNewChat() {
            const res = await fetch('/new_chat', { method: 'POST' });
            const data = await res.json();
            currentChatId = data.id;
            chatBox.innerHTML = '<div class="message ai">Bonjour Nolan. Llama 3.1 pr√™t √† servir.</div>';
            loadConversations();
        }

        async function loadChat(id) {
            currentChatId = id;
            const res = await fetch(`/load_chat/${id}`);
            const messages = await res.json();
            
            chatBox.innerHTML = '';
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.role}`;
                div.innerHTML = marked.parse(msg.content);
                div.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
            loadConversations();
        }

        document.getElementById('input-area').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value;
            if(!text) return;
            
            // Affichage User
            chatBox.innerHTML += `<div class="message user">${marked.parse(text)}</div>`;
            userInput.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if(document.getElementById('screen-toggle').checked) document.body.classList.add('flash');

            // Envoi
            const formData = new FormData();
            formData.append('message', text);
            formData.append('chat_id', currentChatId);
            formData.append('model', document.getElementById('model-select').value);
            formData.append('web', document.getElementById('web-toggle').checked);
            formData.append('screen', document.getElementById('screen-toggle').checked);
            
            const file = document.getElementById('file-input').files[0];
            if(file) { formData.append('file', file); document.getElementById('file-input').value = ""; }

            try {
                const res = await fetch('/ask', { method: 'POST', body: formData });
                const data = await res.json();
                
                chatBox.innerHTML += `<div class="message ai">${marked.parse(data.response)}</div>`;
                chatBox.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                chatBox.scrollTop = chatBox.scrollHeight;
                
                loadConversations();
                document.body.classList.remove('flash');
                if(document.getElementById('screen-toggle').checked) document.getElementById('screen-toggle').checked = false;

            } catch (err) {
                chatBox.innerHTML += `<div class="message ai" style="color:red">Erreur: ${err}</div>`;
            }
        });
    </script>
</body>
</html>